# Whisper 文字起こしシステム <br/>**Version: v1.0.0**

このプロジェクトは OpenAI Whisper を利用して、音声ファイルを文字起こしする Web システムです。

## 事前準備 (Prerequisites)

- **Node.js 18 以上** (npm 同梱) をインストール済みであること  
  ダウンロード → https://nodejs.org/ja/
- **OpenAI アカウントと API キー**（必須・取得方法は下記「OpenAI アカウント & API キー取得ガイド」を参照）
- Git が使える環境（任意）

> ffmpeg は同梱ライブラリ `ffmpeg-static` を使用するため、ローカルにインストール不要です。

---

## 配布版の利用（一般ユーザー向け）

**ZIP などで配布された「配布物」** を使う場合の手順です。フォルダの置き場所はどこでも構いません。

1. 配布物（ZIP）を任意のフォルダに展開します。
2. **`launch.bat` をダブルクリック**します。
   - 初回のみ、必要なパッケージのインストールが行われます。
   - サーバーが起動し、**ブラウザが自動で開きます**。
   - このウィンドウは使用中、**閉じないでください**。
3. **初回起動時、または API キーが未設定の場合**は、画面に「OpenAI API キーを設定してください」と表示されます。
   - 取得した API キー（`sk-...`）を入力し「保存」を押すと、その場で利用可能になります。
4. キーを誤って設定した場合は、画面右上の **「設定」ボタン（歯車アイコン）** から API キーを再設定できます。
5. **バージョン履歴**は、画面右上の **「バージョン履歴」ボタン（時計アイコン）** で表示できます。

---

## 開発者向け：ビルド・開発・配布物の作成

### Makefile（macOS / Linux / Git Bash）

| コマンド        | 説明                                                                 |
| --------------- | -------------------------------------------------------------------- |
| `make install`  | 依存関係をインストール（ルート + client）                            |
| `make build`    | クライアントをビルド（public/ に出力）。本番・配布の前に実行         |
| `make start`    | 本番サーバー起動（http://localhost:3000）                           |
| `make dev`      | 開発モード（サーバー 3000 + Vite 5173）。**http://localhost:5173 を手動で開いて**確認 |
| `make dist`     | **リリース配布物を `dist/` に作成**（v1.0.0）。ZIP で配布可能         |
| `make clean`    | node_modules とビルド成果物を削除                                    |
| `make setup`    | install + build（初回セットアップ）                                  |
| `make help`     | ヘルプ表示                                                           |

Windows では Git Bash または WSL で `make` を実行してください。

### 配布物の作成（make dist）

- リリース用の配布物を作成するには **`make dist`** を実行します。
- `dist/` フォルダに、起動に必要なファイル一式が出力されます。
- 利用者に渡す際は `dist/` をそのまま ZIP にまとめて配布してください。
- 利用者側では、展開後に **`launch.bat`** を実行するだけで起動でき、**フォルダの置き場所に依存しません**。

### 開発時の動作確認（make build / make dev）

- **`make build`** … クライアントをビルドし、`public/` に出力します。`make start` で本番同様に確認できます。
- **`make dev`** … サーバーと Vite を同時に起動します。ブラウザは自動では開かないため、**http://localhost:5173** を手動で開いてください（5173 経由でプロキシが効きます）。

---

## 使い方

1. ブラウザで `http://localhost:3000` を開きます。
2. 音声または動画ファイルを選択し、`文字起こし開始` ボタンを押します。
3. 処理が完了すると、タイムスタンプ付きのテキスト結果が表示されます。
4. `JSON ダウンロード` / `TXT ダウンロード` ボタンで結果を保存できます。

## 技術ポイント

- **バックエンド**: Express / OpenAI SDK / ffmpeg-static + fluent-ffmpeg
- **フロントエンド**: React (Vite) / TypeScript / Tailwind CSS
- 音声は 9 分(540 秒)毎に分割し、サイズ制限 (25MB) を回避しています。
- Whisper API の `verbose_json` + `timestamp_granularities=[segment]` を使い、開始・終了時刻を取得、チャンクオフセットで補正しています。

### 注意事項

- API キーをクライアントサイドに露出しないよう、必ずサーバー側で保持してください。
- 1 時間以上の長尺動画では処理時間が長くなります。サーバースペックに応じて `splitAudio` の分割秒数を調整してください。

---

## トラブルシューティング (Troubleshooting)

### 「サーバーに接続できません」と表示される場合（`make dev` / `npm run dev` 時）

- **症状**: 音声を読み込んで「文字起こし開始」を押すと、画面下部に「サーバーに接続できません。npm run dev または make dev で…」と表示される。
- **原因**: バックエンド（Node サーバー）が起動していないか、すぐに終了している可能性があります。
- **確認と対処**:
  1. **依存関係**: プロジェクトルートで `npm install` を実行してください（`archiver` など追加パッケージが入ります）。
  2. **起動方法**: Windows では `make` が無い場合があります。そのときは **`npm run dev`** を実行してください（`make dev` と同じ動きです）。
  3. **ターミナル表示**: `npm run dev` 実行後、次の 2 つが両方出ているか確認してください。
     - `[0] Server listening on port 3000` のようなメッセージ（サーバー起動）
     - `[1] Local: http://localhost:5173/` のようなメッセージ（Vite 起動）
  4. **エラーが出ている場合**: `[0]` の直後に `Cannot find module 'archiver'` などが出ていれば `npm install` で解消できます。API キー未設定時はサーバーは起動し、画面でキーを設定できます。
  5. **開く URL**: 必ず **http://localhost:5173** を開いてください（3000 ではなく 5173）。5173 経由でないとプロキシが効かず接続できません。

### `launch.bat` を実行してもブラウザが起動しない場合

- `launch.bat` の実行後、プロジェクトフォルダに `launch_log.txt` というファイルが生成されます。
- このファイルに、サーバーの動作記録やエラーメッセージがすべて記録されています。
- 起動に失敗した場合は、このログファイルの内容を確認することで、原因を特定できます。

### 異なるOSで実行すると `ffmpeg` エラーが発生する場合

- **症状**:
  - `Error: spawn ... ffmpeg ENOENT` のようなエラーがターミナルに表示される。
  - 画面上で「サーバーエラー: 500」と表示される。
- **原因**:
  - `npm install` を実行したOSと、現在実行しているOSが異なっているためです。（例: Windowsで `npm install` した `node_modules` フォルダを、そのままUbuntuにコピーして実行した）
  - `ffmpeg-static`ライブラリは、インストール時のOSに合わせた実行ファイルをダウンロードします。そのため、OSが変わると互換性がなくなりエラーとなります。
- **解決策**:
  - 別のOSでプロジェクトを実行する際は、以下のコマンドで依存関係を再構築してください。

  ```bash
  # 1. 古い node_modules と package-lock.json を削除
  rm -rf node_modules
  rm package-lock.json

  # 2. 依存関係を再インストール
  npm install
  ```

  - その後、`npm start` で再度サーバーを起動してください。

---

## OpenAI アカウント & API キー取得ガイド

以下はブラウザ上でのサインアップ〜API キー発行までの一例です。

1. ブラウザで **https://platform.openai.com/** を開き、右上の `Sign up` をクリック (既にアカウントがある場合は `Log in`)。
2. メールアドレス、Google / Microsoft / Apple / 電話番号のいずれかで登録。
3. 名前 (ローマ字可) と生年月日を入力して **Continue**。
4. 「Welcome to OpenAI Platform」と表示されたら `Organization name` に好きな名称 (例: _Personal_) を入力し、用途を選択して **Create organization**。
5. 「Invite your team」は _I'll invite my team later_ を選択してスキップしても OK。
6. 「Make your first API call」で
   - `API key name` に分かりやすい名前 (例: _My Test Key_) を入力
   - **Generate API Key** をクリック
   - 表示された **sk-...** から始まるキーをコピー (一度しか表示されません)。
7. プロジェクト直下の `.env` に貼り付けます。
   ```env
   OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```
   ※クレジット購入画面が表示されます。無料クレジットのみで使う場合は _I'll buy credits later_ をクリックして完了。
8. 既に OpenAI にログイン済みでダッシュボードが表示されている場合は、以下の手順でも API キーを発行できます。
   1. 上部メニュー `Dashboard` へ移動。
   2. 左サイドバー最下部の **API keys** をクリック。
   3. 右上の **Create new secret key** を押下。
   4. 任意の名前を入力し **Create secret key**。
   5. ポップアップに表示された **sk-...** をコピーし `.env` に保存。
   6. 画面を閉じるとキーは再表示できないので必ず控えてください。

> 作成したキーは個人情報です。Git など公開リポジトリには絶対に含めないでください。

### その他の UI 機能

- アップロードできる拡張子を **wav / mp3 / ogg / flac** に限定。誤った形式を選ぶとエラーメッセージを表示します。
- 文字起こし完了時には処理時間 (秒) を表示。
- **設定（歯車アイコン）**: API キーを再設定できます。誤ったキーを設定した場合にここから入力し直してください。
- **バージョン履歴（時計アイコン）**: 現在のバージョンとバージョン履歴を表示します。
- **閉じる (アプリ終了)**: 確認ダイアログで OK を押すとサーバーを停止し、ブラウザタブを閉じます（配布版の場合。開発時はタブのみ閉じる案内になります）。
